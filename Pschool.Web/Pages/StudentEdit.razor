@page "/students/edit/{StudentId:int}"
@inject HttpClient Http
@using Pschool.Web.Models
@using Microsoft.AspNetCore.Components.Forms

<h3>Edit Student</h3><hr />
<EditForm Model="@student" OnValidSubmit="UpdateStudent" class="row">
    @*<ValidationSummary />*@
    <DataAnnotationsValidator />
    <div class="col-md-4">
        <div class="form-group">
            <label for="FirstName">First Name</label>
            <InputText id="FirstName" class="form-control" @bind-Value="student.FirstName" />
            <ValidationMessage For="@(() => student.FirstName)" />
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-group">
            <label for="LastName">Last Name</label>
            <InputText id="LastName" class="form-control" @bind-Value="student.LastName" />
            <ValidationMessage For="@(() => student.LastName)" />
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-group">
            <label for="Email">Email</label>
            <InputText id="Email" class="form-control" @bind-Value="student.Email" />
            <ValidationMessage For="@(() => student.Email)" />
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-group">
            <label for="UserName">Username</label>
            <InputText id="UserName" class="form-control" @bind-Value="student.UserName" />
            <ValidationMessage For="@(() => student.UserName)" />
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-group">
            <label for="Phone">Phone</label>
            <InputText id="Phone" class="form-control" @bind-Value="student.Phone" />
            <ValidationMessage For="@(() => student.Phone)" />
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-group">
            <label for="BirthDate">Birth Date</label>
            <InputDate id="BirthDate" class="form-control" @bind-Value="student.BirthDate" />
            <ValidationMessage For="@(() => student.BirthDate)" />
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-group">
            <label for="ParentId">Parent</label>
            @if (parents != null)
            {
                <select id="ParentId" class="form-control" @bind="student.ParentId">
                    @foreach (var parent in parents)
                    {
                        <option value="@parent.Id">@parent.FirstName @parent.LastName</option>
                    }
                </select>
            }
            else
            {
                <p>No parents data available.</p>
            }
            <ValidationMessage For="@(() => student.ParentId)" />
        </div>
    </div>

    <div class="col-md-12">
        <button type="submit" class="btn btn-primary">Create</button>
    </div>
</EditForm>

@code {
    private Student student = new Student();
    private EditContext editContext;
    private List<Parent> parents;

    protected override void OnInitialized()
    {
        student = new Student();
        editContext = new EditContext(student);
    }

    [Parameter]
    public int StudentId { get; set; }

    [Inject]
    private NavigationManager NavigationManager { get; set; }

    [Inject]
    private HttpClient httpClient { get; set; }

    protected override async Task OnInitializedAsync()
    {
        parents = await Http.GetFromJsonAsync<List<Parent>>("api/Parent");
        student = await Http.GetFromJsonAsync<Student>($"/api/Student/{StudentId}");
    }

    private async Task UpdateStudent()
    {
        // Send a PUT request to update the student
        var response = await httpClient.PutAsJsonAsync($"https://localhost:7130/api/Student/{StudentId}", student);

        if (response.IsSuccessStatusCode)
        {
            // Navigate back to the students list
            NavigationManager.NavigateTo("/students");
        }
        else
        {
            // Handle error
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/students");
    }
}
